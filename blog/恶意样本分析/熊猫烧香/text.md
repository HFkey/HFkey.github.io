# 熊猫烧香
样本来源网络

    IOC
    MD5：512301c535c88255c9a252fdf70b7a03  
    SHA1：ca3a1070cff311c0ba40ab60a8fe3266cfefe870  
    SHA256：40fee2a4be91d9d46cc133328ed41a3bdf9099be5084efbc95c8d0535ecee496

## 1.概述

## 2.详细分析
### 2.1脱壳
查壳，是FSG2.0,不脱壳的话，IDA打开什么都识别不了  
![查壳](/blog/恶意样本分析/熊猫烧香/pic/1.查壳.png)  
![查壳](/blog/恶意样本分析/熊猫烧香/pic/1.5脱壳前IDA.png)

ollybd打开程序  
![打开程序](/blog/恶意样本分析/熊猫烧香/pic/2.打开程序.png)

可以看到，程序先popad之后，esp中已存入OEP地址，之后进行解密，并通过LoadLibraryA()和GetProcAddress()获得API函数地址后，跳转到OEP，这里OEP是0X41D2F8。  
![跳转到OEP](/blog/恶意样本分析/熊猫烧香/pic/3.找OEP.png)  
![跳转到OEP](/blog/恶意样本分析/熊猫烧香/pic/3.找OEP2.png)

解压前OEP入口
![解压前](/blog/恶意样本分析/熊猫烧香/pic/0.解压前入口.png)

解压后OEP入口  
![解压后](/blog/恶意样本分析/熊猫烧香/pic/4.入口处.png)

dump下来  
![dump](/blog/恶意样本分析/熊猫烧香/pic/5.dump.png)

然后修复导入表，先要找到导入表地址，找一个API函数，数据窗口跟随。  
![导入表地址](/blog/恶意样本分析/熊猫烧香/pic/6导入表函数.png)

修改数据查看方式，改为长型-地址。  
![打开程序](/blog/恶意样本分析/熊猫烧香/pic/7引导区.png)

找到导入表开始地址，这里是0x41012C。  
![打开程序](/blog/恶意样本分析/熊猫烧香/pic/8引导区开始处.png)

FSG2.0对内存中的IAT进行了一些空隙填充,需要将其改为0。  
![打开程序](/blog/恶意样本分析/熊猫烧香/pic/9改0.png)

使用工具修复导入表，OEP填入程序入口对基址的相对值()，RVA填入导入表起始值对基址的相对值，Size可以填大一点，后续将多余的无效指针删除就好。  
![打开程序](/blog/恶意样本分析/熊猫烧香/pic/10修复导入表.png)

但是会发现，有两个DLL没有载入上(srvcli.dll和schedcli.dll)，函数识别无效，即使留下这两个函数，转储后也是识别不出来的。  
![打开程序](/blog/恶意样本分析/熊猫烧香/pic/11选择无效函数.png)

那就得转储保存之后，再载入这两个dll。使用LoadPE打开保留这两个函数转储后的文件。